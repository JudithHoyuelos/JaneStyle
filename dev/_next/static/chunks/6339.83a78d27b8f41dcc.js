(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[6339],{6339:function(e,t,n){"use strict";n.r(t);var i=n(7437);n(3233),n(9986),n(3003),n(7130),n(1526);var r=n(2265),o=n(5088),a=n(8516),s=n(9414);t.default=function(e){let{onModelsLoaded:t}=e,{isRecording:n,onRecordStart:c}=(0,s.Z)(),[l,u]=(0,r.useState)(!1),[d,m]=(0,r.useState)(!1),[p,g]=(0,r.useState)(!0),[h,f]=(0,r.useState)(!1),v=(0,r.useCallback)(async()=>{if(o.Mb())m(!0);else try{await o.Eu(),m(!0)}catch(e){m(!1)}},[]);(0,r.useEffect)(()=>{let e=document.querySelector("#AlvyImg");e&&(n?(f(!0),e.setAttribute("src",(0,a.p)("img/icons/microphone.svg")),e.removeAttribute("animation__2"),e.setAttribute("rotation","0 0 0")):n||e.getAttribute("src")!==(0,a.p)("img/icons/microphone.svg")||(e.setAttribute("src",(0,a.p)("img/icons/loading.svg")),e.setAttribute("animation__2","property: rotation; to: 0 0 360; dur: 1000; loop: true; easing: linear;")))},[n]),(0,r.useEffect)(()=>(o.Ud(e=>{let t=document.querySelector("#AlvyImg");if(t){if("audio"===e.command&&e.message){let n=new Audio(URL.createObjectURL(e.message));u(!0),t.setAttribute("rotation","0 0 0"),t.removeAttribute("animation__2"),t.setAttribute("src",(0,a.p)("img/icons/sound.svg")),n.play().catch(e=>{}),n.onended=()=>{u(!1),f(!1),t.setAttribute("src",(0,a.p)("img/icons/click.svg"))}}else t.setAttribute("rotation","0 0 0"),t.removeAttribute("animation__2"),t.setAttribute("src",(0,a.p)("img/icons/click.svg")),f(!1)}}),v(),()=>{o.xU()}),[v]);let y=async()=>{l||h||(g(!1),f(!0),await v(),d?c():f(!1))};return(0,r.useEffect)(()=>{let e=document.getElementById("Alvea"),n=()=>{t()};return e?e.addEventListener("model-loaded",n):console.error("No se encontr\xf3 la entidad con el ID: Alvea"),()=>{e&&e.removeEventListener("model-loaded",n)}},[]),(0,i.jsx)(i.Fragment,{children:(0,i.jsxs)("a-scene",{"hdri-environment":"path: /img/equirectangular/rogland_clear_night_4k.hdr",id:"iframe-id","loading-screen":"enabled: false;",children:[(0,i.jsx)("a-light",{id:"main-light",color:"#bf9b9b",type:"ambient",intensity:"1"}),(0,i.jsx)("a-light",{color:"#bf9b9b",type:"point",intensity:"1",position:"0 10 -9"}),(0,i.jsxs)("a-entity",{id:"rig",position:"0 0 0","movement-controls":"controls: gamepad,keyboard,nipple; constrainToNavMesh: true","nipple-controls":"mode: static; lookJoystickEnabled: false; moveJoystickEnabled:true; moveJoystickPosition: right",children:[(0,i.jsx)("a-entity",{id:"player",position:"0 1.6 0",camera:!0,"look-controls":!0}),(0,i.jsx)("a-entity",{raycaster:"objects: [data-raycastable]; interval: 500",cursor:"rayOrigin: mouse"})]}),(0,i.jsx)("a-entity",{id:"Alvea","gltf-model":"/models/Alvea_Alvearium.glb",position:"0 0 -9",scale:"1 1 1"}),(0,i.jsx)("a-entity",{children:(0,i.jsxs)("a-entity",{id:"Alvy","gltf-model":(0,a.p)("/models/Alvy-AI_Alvearium.glb"),"data-raycastable":!0,followcamera:!0,"look-at":"#player","animation-mixer":"clip: Idle_Anim_Anim_0;",rotation:"0 -90 0",position:"0 1 -15",scale:".15 .15 .15",onClick:y,children:[p&&(0,i.jsx)("a-text",{position:"0 6 0",align:"center",scale:"2 2 2",width:"6","letter-spacing":"2",value:"Pulsa aqui, preguntame y te respondo"}),(0,i.jsx)("a-image",{id:"AlvyImg",src:(0,a.p)("img/icons/click.svg"),animation:"property: position; to: 0 4 0; dur: 2000; easing: linear; loop: true; dir: alternate",position:"0 4.5 0",scale:"1 1 1"})]})}),(0,i.jsx)("a-image",{id:"profileImg","responsive-size":"maxSize: 2",width:"2",height:"2",position:"-10.9 2.25 -9",rotation:"0 90 0",src:(0,a.p)("img/profile-picture.svg")}),(0,i.jsx)("a-entity",{id:"Navmesh","gltf-model":"/models/navmesh-circle.gltf","nav-mesh":!0,position:"0 .1 -9",scale:"20 .1 22",visible:"false"})]})})}},3003:function(){AFRAME.registerComponent("followcamera",{init:function(){this.cameraEl=document.querySelector("[camera]"),this.offset=new THREE.Vector3(-.5,.5,-3),this.speed=.02,this.stopDistance=.01,this.yMin=1.5,this.yMax=3,this.circleCenter=new THREE.Vector3(0,0,-9),this.radius=5},tick:function(e,t){if(this.cameraEl){var n=this.cameraEl.object3D,i=this.el.object3D,r=new THREE.Vector3;n.getWorldPosition(r);var o=r.clone().add(this.offset.clone().applyQuaternion(n.quaternion)),a=i.position;if(o.distanceTo(a)>this.stopDistance){var s=o.clone().sub(a).normalize();a.addScaledVector(s,this.speed*t/16)}var c=a.x-this.circleCenter.x,l=a.z-this.circleCenter.z,u=Math.sqrt(c*c+l*l);if(u>this.radius){var d=this.radius/u;a.x=this.circleCenter.x+c*d,a.z=this.circleCenter.z+l*d}a.y<this.yMin?a.y=this.yMin:a.y>this.yMax&&(a.y=this.yMax),i.quaternion.copy(n.quaternion)}}})},1526:function(e,t,n){"use strict";var i=n(3257),r=n(3086);AFRAME.registerComponent("exr-background",{init:function(){let e=this.el.sceneEl,t=e.renderer,n=e.object3D;new i.I().load("/img/equirectangular/evening_field_2k.exr",function(e){e.mapping=THREE.EquirectangularReflectionMapping,n.environment=e,n.background=e,t.outputEncoding=THREE.sRGBEncoding,t.toneMapping=THREE.ACESFilmicToneMapping,t.toneMappingExposure=.5})}}),AFRAME.registerComponent("responsive-size",{schema:{maxSize:{type:"number",default:2}},init:function(){let e=this.el;e.addEventListener("materialtextureloaded",()=>{let t,n;let i=e.getObject3D("mesh");if(!i||!i.material||!i.material.map||!i.material.map.image)return;let r=i.material.map.image,o=this.data.maxSize,a=r.width/r.height;a>1?(t=o,n=o/a):(n=o,t=o*a),e.setAttribute("width",t),e.setAttribute("height",n)})}}),AFRAME.registerComponent("hdri-environment",{schema:{path:{type:"string",default:""}},init:function(){if(!this.data.path){console.error('El atributo "path" es necesario para el componente hdri-environment.');return}let e=this.el.sceneEl,t=e.renderer;if(!t){console.error("No se encontr\xf3 el renderizador de THREE.js. Aseg\xfarate de que A-Frame est\xe1 inicializado correctamente.");return}let n=new THREE.PMREMGenerator(t);new r.x().load(this.data.path,t=>{let i=n.fromEquirectangular(t).texture;t.dispose();let r=e.object3D;r.environment=i,r.background=i},void 0,e=>{console.error("Error al cargar la textura HDRI:",e)})}})},7130:function(){var e,t=AFRAME.utils.debug,n=AFRAME.utils.coordinates,i=t("components:look-at:warn"),r=n.isCoordinates||n.isCoordinate;delete AFRAME.components["look-at"],AFRAME.registerComponent("look-at",{schema:{default:"0 0 0",parse:function(e){return r(e)||"object"==typeof e?n.parse(e):e},stringify:function(e){return"object"==typeof e?n.stringify(e):e}},init:function(){this.target3D=null,this.vector=new THREE.Vector3,this.cameraListener=AFRAME.utils.bind(this.cameraListener,this),this.el.addEventListener("componentinitialized",this.cameraListener),this.el.addEventListener("componentremoved",this.cameraListener)},update:function(){var e,t=this,n=t.data;if(!n||"object"==typeof n&&!Object.keys(n).length)return t.remove();if("object"==typeof n)return this.lookAt(new THREE.Vector3(n.x,n.y,n.z)),this.endTracking();if(!(e=t.el.sceneEl.querySelector(n))){i('"'+n+'" does not point to a valid entity to look-at');return}return e.hasLoaded?t.beginTracking(e):e.addEventListener("loaded",function(){t.beginTracking(e)})},tick:(e=new THREE.Vector3,function(t){var n=this.target3D;n&&(n.getWorldPosition(e),this.lookAt(e))}),remove:function(){this.el.removeEventListener("componentinitialized",this.cameraListener),this.el.removeEventListener("componentremoved",this.cameraListener)},beginTracking:function(e){this.target3D=e.object3D},endTracking:function(){this.target3D=null},cameraListener:function(e){e.detail&&"camera"===e.detail.name&&this.update()},lookAt:function(e){var t=this.vector,n=this.el.object3D;this.el.getObject3D("camera")?t.subVectors(n.position,e).add(n.position):t.copy(e),n.lookAt(t)}})},9414:function(e,t,n){"use strict";var i=n(2265),r=n(5088);t.Z=function(){let[e,t]=(0,i.useState)(!1),[n,o]=(0,i.useState)(null),[a,s]=(0,i.useState)(null),[c,l]=(0,i.useState)(null),[u,d]=(0,i.useState)(!1),m=(0,i.useRef)([]),p=(0,i.useRef)(null),g=(0,i.useRef)(null),h=(0,i.useRef)(null),f=(0,i.useRef)(null),v=(0,i.useRef)(null);v.current=new Audio("/audio/beep.mp3");let y=(0,i.useCallback)(()=>{v.current&&v.current.play()},[]),b=(0,i.useCallback)(async e=>{if(e){try{await r.kI(e)}catch(e){console.error("Error enviando el audio:",e)}d(!0),s(null),o(null),l(null)}},[]),A=(0,i.useCallback)(async()=>{if(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia)try{y(),await new Promise(e=>setTimeout(e,500));let e=await navigator.mediaDevices.getUserMedia({audio:!0}),n=new MediaRecorder(e);p.current=n,n.start(),t(!0);let i=new(window.AudioContext||window.webkitAudioContext);h.current=i;let r=i.createMediaStreamSource(e);await i.audioWorklet.addModule("/silence-detector-worklet.js");let a=new AudioWorkletNode(i,"silence-detector");f.current=a,r.connect(a),a.connect(i.destination),a.port.onmessage=e=>{let{averageVolume:t}=e.data;t<.1?g.current||(g.current=setTimeout(()=>{E()},2e3)):(clearTimeout(g.current),g.current=null)},n.ondataavailable=e=>{m.current.push(e.data)},n.onstop=async()=>{y(),await new Promise(e=>setTimeout(e,500));let e=MediaRecorder.isTypeSupported("audio/webm")?"audio/webm":"audio/mp4",n=new Blob(m.current,{type:e}),c=new Blob(m.current,{type:"audio/mpeg"});console.log("Audio enviado:",e,n);let u=URL.createObjectURL(c);s(n),o(u),m.current=[],t(!1);try{let e=await n.arrayBuffer(),t=await i.decodeAudioData(e);l(t.duration)}catch(e){console.error("Error al calcular la duraci\xf3n del audio:",e),l(0)}b(n),a.disconnect(),r.disconnect(),i.close()}}catch(e){console.error("Error al iniciar la grabaci\xf3n:",e)}},[b,y]),E=(0,i.useCallback)(()=>{p.current&&(p.current.stop(),clearTimeout(g.current),g.current=null)},[]);return{isRecording:e,audioUrl:n,audioBlob:a,audioDuration:c,isSendingAudio:u,setIsSendingAudio:d,onRecordStart:A,onRecordStop:E}}},5088:function(e,t,n){"use strict";n.d(t,{Eu:function(){return c},Mb:function(){return m},Ud:function(){return d},kI:function(){return u},xU:function(){return l}});var i=n(8856),r=n(2615);let o=null,a=null;class s{constructor({command:e,message:t}){if(this.VALID_COMMANDS=Object.freeze({ERROR:"error",COMMAND:"command",MESSAGE:"message",USER_MESSAGE:"user-message",AUDIO:"audio",USER_AUDIO:"user-audio"}),void 0===e||!Object.values(this.VALID_COMMANDS).includes(e))throw TypeError('Paramter "command" is required and only can be '+Object.values(this.VALID_COMMANDS).reduce((e,t)=>e+=" ".concat(t)),"");if(void 0===t)throw TypeError('Paramter "message" is required');this.command=e,this.message=t}}function c(){o=new WebSocket("".concat(r.p.DOMAIN_WS,"/ai_integrations/alvy/chat/?translator=gemini"));let e=!0;o.onmessage=function(t){let n;try{n=new s(JSON.parse(t.data))}catch(e){console.log("Error parsing AlvyMessage"),console.error(e)}if(n.command===n.VALID_COMMANDS.AUDIO&&(n.message=function(e){let t=atob(e),n=t.length,i=new Uint8Array(n);for(let e=0;e<n;e++)i[e]=t.charCodeAt(e);return new Blob([i],{type:"audio/mpeg"})}(n.message)),null===a){console.error("Alvy.onResponseCallback no defined!\nMessage: ",n);return}if(n.command===n.VALID_COMMANDS.ERROR&&n.message.includes("Invalid JWT or Bad Permissions")&&((0,i.j1)(""),location.reload()),e){e=!1;return}a(n)},o.onopen=()=>{let e=new s({command:"command",message:(0,i.hP)()});o.send(JSON.stringify(e))}}function l(){null!==o&&o.close()}async function u(e){if(null===o)throw Error("Alvy error: WebSocket connection no started.");let t=new s({command:"audio",message:await new Promise((t,n)=>{let i=new FileReader;i.onloadend=()=>{t(i.result.split(",")[1])},i.onerror=n,i.readAsDataURL(e)})});return o.send(JSON.stringify(t)),new s({command:"user-audio",message:e})}function d(e){a=e}function m(){return null!==o&&o.readyState===WebSocket.OPEN}}}]);